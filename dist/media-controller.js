import f from"./media-container.js";import{defineCustomElement as R}from"./utils/defineCustomElement.js";import{Window as E}from"./utils/server-safe-globals.js";import{fullscreenApi as c}from"./utils/fullscreenApi.js";import{constToCamel as p}from"./utils/stringUtils.js";import{MediaUIEvents as m,MediaUIAttributes as r}from"./constants.js";const{MEDIA_PLAY_REQUEST:U,MEDIA_PAUSE_REQUEST:S,MEDIA_MUTE_REQUEST:T,MEDIA_UNMUTE_REQUEST:v,MEDIA_VOLUME_REQUEST:g,MEDIA_ENTER_FULLSCREEN_REQUEST:D,MEDIA_EXIT_FULLSCREEN_REQUEST:b,MEDIA_SEEK_REQUEST:P,MEDIA_PREVIEW_REQUEST:C,MEDIA_ENTER_PIP_REQUEST:L,MEDIA_EXIT_PIP_REQUEST:w,MEDIA_PLAYBACK_RATE_REQUEST:N}=m;class I extends f{constructor(){super();this.associatedElements=[],this.monitoredElements=[],this.associateElement(this);const e={MEDIA_MUTE_REQUEST:()=>this.media.muted=!0,MEDIA_UNMUTE_REQUEST:()=>{const t=this.media;t.muted=!1,t.volume===0&&(t.volume=.25)},MEDIA_VOLUME_REQUEST:t=>{const s=this.media,a=t.detail;s.volume=a,a>0&&s.muted&&(s.muted=!1);try{E.localStorage.setItem("media-chrome-pref-volume",a.toString())}catch(n){}},MEDIA_ENTER_FULLSCREEN_REQUEST:()=>{const t=this.getRootNode();t.pictureInPictureElement&&t.exitPictureInPicture(),super[c.enter]()},MEDIA_EXIT_FULLSCREEN_REQUEST:()=>{this.getRootNode()[c.exit]()},MEDIA_ENTER_PIP_REQUEST:()=>{const t=this.getRootNode(),s=this.media;!t.pictureInPictureEnabled||(t[c.element]&&t[c.exit](),s.requestPictureInPicture())},MEDIA_EXIT_PIP_REQUEST:()=>{const t=this.getRootNode();t.exitPictureInPicture&&t.exitPictureInPicture()},MEDIA_SEEK_REQUEST:t=>{const s=this.media,a=t.detail;(s.readyState>0||s.readyState===void 0)&&(s.currentTime=a)},MEDIA_PLAYBACK_RATE_REQUEST:t=>{this.media.playbackRate=t.detail},MEDIA_PREVIEW_REQUEST:t=>{const s=this.media,a=t.detail;if(s&&s.textTracks&&s.textTracks.length){let n=Array.prototype.find.call(s.textTracks,d=>d.label=="thumbnails");if(!n||!n.cues)return;let o=Array.prototype.find.call(n.cues,d=>d.startTime>=a);if(o){const d=new URL(o.text),h=new URLSearchParams(d.hash).get("#xywh");this.propagateMediaState(r.MEDIA_PREVIEW_IMAGE,d.href),this.propagateMediaState(r.MEDIA_PREVIEW_COORDS,h.split(",").join(" "))}}}};Object.keys(e).forEach(t=>{const s=`_handle${p(t,!0)}`;this[s]=a=>{if(a.stopPropagation(),!this.media){console.warn("MediaController: No media available.");return}e[t](a,this.media)},this.addEventListener(m[t],this[s])}),this._mediaStatePropagators={"play,pause":()=>{this.propagateMediaState(r.MEDIA_PAUSED,this.media.paused)},volumechange:()=>{const{muted:t,volume:s}=this.media;let a="high";s==0||t?a="off":s<.5?a="low":s<.75&&(a="medium"),this.propagateMediaState(r.MEDIA_MUTED,t),this.propagateMediaState(r.MEDIA_VOLUME,s),this.propagateMediaState(r.MEDIA_VOLUME_LEVEL,a)},[c.event]:()=>{const t=this.getRootNode()[c.element];this.propagateMediaState(r.MEDIA_IS_FULLSCREEN,t===this)},"enterpictureinpicture,leavepictureinpicture":t=>{let s;t?s=t.type=="enterpictureinpicture":s=this.media==this.getRootNode().pictureInPictureElement,this.propagateMediaState(r.MEDIA_IS_PIP,s)},"timeupdate,loadedmetadata":()=>{this.propagateMediaState(r.MEDIA_CURRENT_TIME,this.media.currentTime)},"durationchange,loadedmetadata":()=>{this.propagateMediaState(r.MEDIA_DURATION,this.media.duration)},ratechange:()=>{this.propagateMediaState(r.MEDIA_PLAYBACK_RATE,this.media.playbackRate)}},this.setupAssociatedElement(this)}connectedCallback(){l(this).forEach(this.setupAssociatedElement.bind(this)),super.connectedCallback()}mediaSetCallback(e){if(!!super.mediaSetCallback(e)){Object.keys(this._mediaStatePropagators).forEach(t=>{const s=t.split(","),a=this._mediaStatePropagators[t];s.forEach(n=>{(n==c.event?this.getRootNode():e).addEventListener(n,a)}),a()});try{const t=E.localStorage.getItem("media-chrome-pref-volume");t!==null&&(e.volume=t)}catch(t){console.debug("Error getting volume pref",t)}}}mediaUnsetCallback(e){super.mediaUnsetCallback(e),Object.keys(this._mediaStatePropagators).forEach(t=>{const{events:s,handler:a}=this.mediaStatePropagators[t];s.forEach(n=>{(n==c.event?this.getRootNode():e).removeEventListener(n,a)})}),this.propagateMediaState(r.MEDIA_PAUSED,!0)}propagateMediaState(e,t){u(this.associatedElements,e,t)}associateElement(e){if(!e)return;const t=this.monitoredElements;if(t.some(d=>d.element===e))return;const s=l(e),a=this.setupAssociatedElement.bind(this),n=this.teardownAssociatedElement.bind(this);s.forEach(a);const o=B(e,a,n);t.push({element:e,unsubscribe:o})}unassociateElement(e){if(!e)return;const t=this.monitoredElements,s=t.findIndex(d=>d.element===e);if(s<0)return;const a=l(e),n=this.teardownAssociatedElement.bind(this);a.forEach(n);const{unsubscribe:o}=t[s];o(),t.splice(s,1)}setupAssociatedElement(e){if(!e)return;const t=this.associatedElements;t.indexOf(e)>-1||(t.push(e),Object.keys(m).forEach(a=>{e.addEventListener(m[a],this[`_handle${p(a,!0)}`])}),this.media&&(u([e],r.MEDIA_PAUSED,this.media.paused),u([e],r.MEDIA_MUTED,this.media.muted),u([e],r.MEDIA_VOLUME,this.media.volume),u([e],r.MEDIA_CURRENT_TIME,this.media.currentTime),u([e],r.MEDIA_DURATION,this.media.duration),u([e],r.MEDIA_PLAYBACK_RATE,this.media.playbackRate)))}teardownAssociatedElement(e){const t=this.associatedElements,s=t.indexOf(e);s<0||(t.splice(s,1),Object.keys(m).forEach(a=>{e.removeEventListener(m[a],this[`_handle${p(a,!0)}`])}))}play(){this.dispatchEvent(new E.CustomEvent(U))}pause(){this.dispatchEvent(new E.CustomEvent(S))}get muted(){return!!(this.media&&this.media.muted)}set muted(e){const t=e?T:v;this.dispatchEvent(new E.CustomEvent(t))}get volume(){const e=this.media;return e?e.volume:1}set volume(e){this.dispatchEvent(new E.CustomEvent(g,{detail:e}))}requestFullscreen(){this.dispatchEvent(new E.CustomEvent(D))}exitFullscreen(){this.dispatchEvent(new E.CustomEvent(b))}get currentTime(){const e=this.media;return e?e.currentTime:0}set currentTime(e){this.dispatchEvent(new E.CustomEvent(P,{detail:e}))}get playbackRate(){const e=this.media;return e?e.playbackRate:1}set playbackRate(e){this.dispatchEvent(new E.CustomEvent(N,{detail:e}))}requestPictureInPicture(){this.dispatchEvent(new E.CustomEvent(L))}exitPictureInPicture(){this.dispatchEvent(new E.CustomEvent(w))}requestPreview(e){this.dispatchEvent(new E.CustomEvent(C,{detail:e}))}}const y=Object.values(r),A=i=>{var s,a,n;const{constructor:{observedAttributes:e}}=i,t=(n=(a=(s=i==null?void 0:i.getAttribute)==null?void 0:s.call(i,r.MEDIA_CHROME_ATTRIBUTES))==null?void 0:a.split)==null?void 0:n.call(a,/\s+/);return Array.isArray(e||t)?(e||t).filter(o=>y.includes(o)):[]},O=i=>!!A(i).length,x=(i,e,t)=>typeof t=="boolean"?t?i.setAttribute(e,""):i.removeAttribute(e):i.setAttribute(e,t),Q=i=>(i==null?void 0:i.slot)==="media",k=i=>!!i.closest('*[slot="media"]'),j=i=>{var e,t,s;return!!(((e=i==null?void 0:i.childNodes)==null?void 0:e.length)||((s=(t=i==null?void 0:i.shadowRoot)==null?void 0:t.childNodes)==null?void 0:s.length))},F=i=>!Q(i)&&j(i),l=i=>{var n,o;const e=O(i)&&!k(i)?[i]:[];if(!F(i))return e;const{childNodes:t=[]}=i!=null?i:{},s=(o=(n=i==null?void 0:i.shadowRoot)==null?void 0:n.childNodes)!=null?o:[],a=[...t,...s];return[...e,...Array.prototype.flatMap.call(a,l)]},V=(i=[])=>i.reduce((t,s)=>{const{addedNodes:a=[],removedNodes:n=[],type:o,target:d,attributeName:h}=s;if(o==="childList"){const _=Array.prototype.flatMap.call(a,l),M=Array.prototype.flatMap.call(n,l);return t.addedNodes.push(..._),t.removedNodes.push(...M),t}return o==="attributes"&&h===r.MEDIA_CHROME_ATTRIBUTES&&(A(d).length?t.addedNodes.push(d):t.removedNodes.push(d)),t},{addedNodes:[],removedNodes:[]}),u=(i,e,t)=>{i.forEach(s=>{s.slot==="media"||!A(s).includes(e)||x(s,e,t)})},B=(i,e,t)=>{const s=(n,o)=>{const{addedNodes:d,removedNodes:h}=V(n);d.forEach(e),h.forEach(t)},a=new MutationObserver(s);return a.observe(i,{childList:!0,attributes:!0,subtree:!0}),()=>a.disconnect()};R("media-controller",I);export default I;
